<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Welcome to GeoPulse</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"
    />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
    <script
      src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"
      defer
    ></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
        margin: 0;
        padding: 0;
      }
      h1 {
        margin-top: 20px;
      }
      #counter {
        font-size: 18px;
        margin-bottom: 10px;
      }
      #map {
        height: 80vh;
        width: 100%;
      }
      .leaflet-popup-content {
        text-align: center;
      }
      .leaflet-popup-content img {
        max-width: 150px;
        max-height: 150px;
        border-radius: 8px;
        cursor: pointer;
      }
      /* Bounce animation */
      @keyframes bounce {
        0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
        40% {transform: translateY(-20px);}
        60% {transform: translateY(-10px);}
      }
      .bounce-marker {
        animation: bounce 1s;
      }
      /* Info box */
      #info-box {
        position: fixed;
        bottom: 20px;
        right: 20px;
        max-width: 300px;
        background: white;
        border: 2px solid #333;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0,0,0,0.3);
        display: none;
        text-align: left;
        z-index: 10000;
      }
      #info-box button {
        margin-top: 10px;
        float: right;
        cursor: pointer;
      }
      table {
        margin: 10px auto 30px;
        border-collapse: collapse;
        width: 300px;
      }
      table, th, td {
        border: 1px solid #333;
      }
      th, td {
        padding: 8px;
      }
    </style>
</head>
<body>
    <h1>Welcome to GeoPulse</h1>
    <div id="counter">Total Visits: {{ visit_count }}</div>
    <div id="map"></div>

    <h2>Visits per Region</h2>
    <table>
      <thead>
        <tr><th>Region</th><th>Visits</th></tr>
      </thead>
      <tbody>
        {% for region, visits in visits_per_region.items() %}
          <tr><td>{{ region }}</td><td>{{ visits }}</td></tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- Info Box -->
    <div id="info-box">
      <button id="close-info">Close</button>
      <div id="info-content"></div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const map = L.map("map").setView([{{ center_lat }}, {{ center_lon }}], 2);

        L.tileLayer(
          "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
          { maxZoom: 18 }
        ).addTo(map);

        const markers = L.markerClusterGroup();
        const pins = {{ pins | tojson | safe }};
        const imageBaseUrl = "{{ url_for('static', filename='images/') }}";

        // Info box elements
        const infoBox = document.getElementById("info-box");
        const infoContent = document.getElementById("info-content");
        const closeBtn = document.getElementById("close-info");

        closeBtn.addEventListener("click", () => {
          infoBox.style.display = "none";
        });

        pins.forEach((pin) => {
          const marker = L.marker([pin.lat, pin.lon]);
          const popupContent = `
            <b>${pin.name}</b><br>
            <img 
                src="${imageBaseUrl}${pin.image}" 
                alt="${pin.name}" 
                style="max-width: 150px; max-height: 150px; border-radius: 8px; cursor:pointer;"
                id="img-${pin.name.replace(/\s+/g, '-')}"
            />
          `;

          marker.bindPopup(popupContent);

          marker.on('popupopen', function() {
            const img = document.getElementById(`img-${pin.name.replace(/\s+/g, '-')}`);
            if (img) {
              img.addEventListener('click', () => {
                showInfo(pin.name, pin.info);
              });
            }
            marker._icon.classList.add('bounce-marker');
          });

          markers.addLayer(marker);
        });

        map.addLayer(markers);

        window.showInfo = function (name, info) {
          infoContent.innerHTML = `<h3>${name}</h3><p>${info}</p>`;
          infoBox.style.display = "block";
        };
      });
    </script>
</body>
</html>
